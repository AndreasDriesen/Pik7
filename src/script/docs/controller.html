<!DOCTYPE html>  <html> <head>   <title>controller.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="controls.html">                 controls.coffee               </a>                                           <a class="source" href="emitter.html">                 emitter.coffee               </a>                                           <a class="source" href="hash.html">                 hash.coffee               </a>                                           <a class="source" href="iframe.html">                 iframe.coffee               </a>                                           <a class="source" href="presentation.html">                 presentation.coffee               </a>                                           <a class="source" href="smartEmitter.html">                 smartEmitter.coffee               </a>                                           <a class="source" href="state.html">                 state.coffee               </a>                                           <a class="source" href="sync.html">                 sync.coffee               </a>                                           <a class="source" href="pik7.html">                 pik7.coffee               </a>                                           <a class="source" href="slides.html">                 slides.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               controller.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>A controller instance connects many emitters and provides an api to control the
whole application. It's an umbrealla for:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <ol>
<li>a <code>State</code> emitter</li>
<li>a <code>Sync</code> instance</li>
<li>a <code>Hash</code> instance</li>
<li>any number of <code>Controls</code> instances</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;lib/state&#39;</span><span class="p">,</span> <span class="s1">&#39;lib/sync&#39;</span><span class="p">,</span> <span class="s1">&#39;lib/hash&#39;</span><span class="p">,</span> <span class="s1">&#39;lib/controls&#39;</span><span class="p">],</span> <span class="nf">(State, Sync, Hash, Controls) -&gt;</span>

  <span class="k">return</span> <span class="k">class</span> <span class="nx">Controller</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create state object using <code>defaults</code>, create and connect emitters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">constructor: </span><span class="nf">(defaults) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Create emitters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@hash = </span><span class="k">new</span> <span class="nx">Hash</span><span class="p">()</span>
      <span class="vi">@sync = </span><span class="k">new</span> <span class="nx">Sync</span><span class="p">()</span>
      <span class="vi">@controls = </span><span class="k">new</span> <span class="nx">Controls</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Create state</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">initialState = </span><span class="nx">@bootstrapState</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
      <span class="vi">@state = </span><span class="k">new</span> <span class="nx">State</span><span class="p">(</span><span class="nx">initialState</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Connect emitters</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@connectHash</span> <span class="nx">@hash</span>
      <span class="nx">@connectSync</span> <span class="nx">@sync</span>
      <span class="nx">@connectControls</span><span class="p">(</span><span class="nx">@controls</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Run the initial state update</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@initialUpdate</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Get the startup state from the url and/or the syncer. Fall back to <code>defauls</code> if
necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bootstrapState: </span><span class="nf">(defaults) -&gt;</span>
      <span class="nv">fromUrl = </span><span class="nx">@hash</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="nv">fromSync = </span><span class="nx">@sync</span><span class="p">.</span><span class="nx">getState</span><span class="p">()</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">file: </span><span class="nx">fromUrl</span><span class="p">.</span><span class="nx">file</span> <span class="o">||</span> <span class="nx">fromSync</span><span class="p">.</span><span class="nx">file</span> <span class="o">||</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">file</span>
        <span class="nv">slide: </span><span class="nx">fromUrl</span><span class="p">.</span><span class="nx">slide</span> <span class="o">||</span> <span class="nx">fromSync</span><span class="p">.</span><span class="nx">slide</span> <span class="o">||</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">slide</span>
        <span class="nv">hidden: </span><span class="nx">fromUrl</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">||</span> <span class="nx">fromSync</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">||</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">hidden</span>
        <span class="nv">numSlides: </span><span class="nx">defaults</span><span class="p">.</span><span class="nx">numSlides</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>After a state has been established, update Hash and Sync once</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initialUpdate: </span><span class="nf">() -&gt;</span>
      <span class="nv">file = </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
      <span class="nv">slide = </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">)</span>
      <span class="nv">hidden = </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">)</span>
      <span class="nx">@hash</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">slide</span><span class="p">,</span> <span class="nx">hidden</span><span class="p">)</span>
      <span class="nx">@sync</span><span class="p">.</span><span class="nx">setState</span> <span class="p">{</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">slide</span><span class="p">,</span> <span class="nx">hidden</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Connect Emitters</h2>

<ol>
<li>Emitter lauschen auf dem Manager</li>
<li>Emitter lösen state.update aus</li>
<li>state.update löst ggf. (falls es wirklich ein Update war) auf dem Manager aus
Explizite Objekt-Übergabe erleichtet später das Verbinden weiterer Emitter (z.B. für Controls aus dem Frame)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ol>
<li>Listen for hash changes and update the state accordingly</li>
<li>When an event fires on the state, update the hash using <code>stateCb</code></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">connectHash: </span><span class="nf">(emitter) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Listen on the hash emitter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">emitter</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@state</span><span class="p">.</span><span class="nx">set</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">emitter</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Listen on the state emitter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">onstatechange = </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">emitter</span><span class="p">.</span><span class="nx">update</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="c1"># `update` sollte `setState` heißen, wie bei Sync</span>
          <span class="nv">file: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
          <span class="nv">slide: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">)</span>
          <span class="nv">hidden: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">onstatechange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">onstatechange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">)</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">onstatechange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ol>
<li>Listen on the emitter's change event and update the state accordingly</li>
<li>When an event fires on the state, update the sync storage using <code>set()</code></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">connectSync: </span><span class="nf">(emitter) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Listen on the sync emitter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">emitter</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><strong>HACK HACK HACK HACK</strong>
If we use the value passed to this callback to set the state, the state is
changed one value at a time. This would only work for changes that only
touch one of the state's properties - if more properties are changed after
one another, it gets nasty as soon more than one window is involved. What
happens is that when we update the state <code>{ a:x, b:1 }</code> to <code>{ a:y, b:1 }</code> and
then to <code>{ a:y, b:2 }</code>, the storage event for <code>{ a:y, b:1 }</code> is triggered on
other windows <em>after</em> we set <code>{ a:y, b:2 }</code> on our window. So the other
window triggers an event for <code>{ a:y, b:1 }</code>, while we are already on
<code>{ a:y, b:2 }</code>, so we update and trigger an event, while the other window
recieves <code>{ a:y, b:2 }</code> ... and we've got ourselfes a nice endless loop.
This can be "fixed" by not actually setting the state to the value that
the Sync callback reports, but to the value that's currently in the sync's
storage. This works because storage events <em>always</em> fire only after all
changes to the storage are applied, even for multiple changes in sequence.
This allows us to fake a bulk update of the state, which fixes the
endless loop problem.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@state</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@sync</span><span class="p">.</span><span class="nx">getState</span><span class="p">(),</span> <span class="nx">emitter</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Listen on the state emitter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">onstatechange = </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nf">(value) -&gt;</span> <span class="nx">onstatechange</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nf">(value) -&gt;</span> <span class="nx">onstatechange</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nf">(value) -&gt;</span> <span class="nx">onstatechange</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Connect the contol emitter's events directly to the api methods</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">connectControls: </span><span class="nf">(emitter) -&gt;</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;prev&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@goPrev</span><span class="p">()</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@goNext</span><span class="p">()</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;toggleHidden&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@toggleHidden</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>API</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Expose the state manager's event hooks, but hide the "smart" parts
of the SmartEmitter's functionality</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kc">on</span><span class="o">:</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span> <span class="c1"># add `null` as the `subscriber` object</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">on</span> <span class="nx">args</span><span class="p">...</span>
    <span class="nv">trigger: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span> <span class="c1"># add `null` as the `caller` object</span>
      <span class="nx">@state</span><span class="p">.</span><span class="nx">trigger</span> <span class="nx">args</span><span class="p">...</span>
    <span class="kc">off</span><span class="o">:</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">@state</span><span class="p">.</span><span class="kc">off</span> <span class="nx">args</span><span class="p">...</span>
    <span class="nv">offAll: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">@state</span><span class="p">.</span><span class="nx">offAll</span> <span class="nx">args</span><span class="p">...</span>
      <span class="nx">@hash</span><span class="p">.</span><span class="nx">offAll</span> <span class="nx">args</span><span class="p">...</span>
      <span class="nx">@sync</span><span class="p">.</span><span class="nx">offAll</span> <span class="nx">args</span><span class="p">...</span>
      <span class="nx">@controls</span><span class="p">.</span><span class="nx">offAll</span> <span class="nx">args</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Get and set the current file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getFile: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@state</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;file&#39;</span>
    <span class="nv">openFile: </span><span class="nf">(newFile) -&gt;</span>
      <span class="nx">@state</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span> <span class="nv">file: </span><span class="nx">newFile</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Get and navigate the slides</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getSlide: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@state</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;slide&#39;</span>
    <span class="nv">goTo: </span><span class="nf">(num) -&gt;</span>
      <span class="nx">@state</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span> <span class="nv">slide: </span><span class="nb">Number</span> <span class="nx">num</span> <span class="p">}</span>
    <span class="nv">goNext: </span><span class="o">-&gt;</span>
      <span class="nx">@goTo</span><span class="p">(</span><span class="nx">@getSlide</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nv">goPrev: </span><span class="o">-&gt;</span>
      <span class="nx">@goTo</span><span class="p">(</span><span class="nx">@getSlide</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Get, set and toggle the hidden state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getHidden: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@state</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;hidden&#39;</span>
    <span class="nv">setHidden: </span><span class="nf">(state) -&gt;</span>
      <span class="nx">@state</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span> <span class="nv">hidden: </span><span class="nx">state</span> <span class="p">}</span>
    <span class="nv">toggleHidden: </span><span class="o">-&gt;</span>
      <span class="nx">@setHidden</span> <span class="o">!</span><span class="nx">@getHidden</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 