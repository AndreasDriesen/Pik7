<!DOCTYPE html>  <html> <head>   <title>smartEmitter.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="controls.html">                 controls.coffee               </a>                                           <a class="source" href="emitter.html">                 emitter.coffee               </a>                                           <a class="source" href="hash.html">                 hash.coffee               </a>                                           <a class="source" href="iframe.html">                 iframe.coffee               </a>                                           <a class="source" href="presentation.html">                 presentation.coffee               </a>                                           <a class="source" href="smartEmitter.html">                 smartEmitter.coffee               </a>                                           <a class="source" href="state.html">                 state.coffee               </a>                                           <a class="source" href="sync.html">                 sync.coffee               </a>                                           <a class="source" href="pik7.html">                 pik7.coffee               </a>                                           <a class="source" href="slides.html">                 slides.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               smartEmitter.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Smart Emitters are used to connect many other emitters. Their <code>on()</code> and <code>trigger()</code>
methods take an additional argument that identifies the emitter that is listening for
or triggering events. This allows the Smart Emitter to not propagate events back to
the objects that triggered them in the first place.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;lib/emitter&#39;</span><span class="p">],</span> <span class="nf">(Emitter) -&gt;</span>

  <span class="nv">compareArrays = </span><span class="nf">(a, b) -&gt;</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">for</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">when</span> <span class="nx">val</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">true</span>

  <span class="k">class</span> <span class="nx">SmartEmitter</span> <span class="k">extends</span> <span class="nx">Emitter</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Add the callbacks to the topics and add the <code>__subscriber__</code> property
<em>afterwards</em>. This order allows <code>__super__.on</code> to deal with non-function
values for <code>callback</code> before any properties are added.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kc">on</span><span class="o">:</span> <span class="nf">(topic, subscriber, callback) -&gt;</span>
      <span class="k">super</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">callback</span>
      <span class="nv">callback.__subscriber__ = </span><span class="nx">subscriber</span> <span class="k">if</span> <span class="nx">subscriber</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Trigger all callbacks for the given topic if the callback's <code>__subscriber__</code>
property isn't equal to <code>caller</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">trigger: </span><span class="nf">(topic, caller, args...) -&gt;</span>
      <span class="k">if</span> <span class="nx">caller</span><span class="o">?</span>
        <span class="nv">topics = </span><span class="p">{}</span>
        <span class="k">for</span> <span class="nx">_topic</span><span class="p">,</span> <span class="nx">callbacks</span> <span class="k">of</span> <span class="nx">@topics</span>
          <span class="nx">topics</span><span class="p">[</span><span class="nx">_topic</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cb</span> <span class="k">for</span> <span class="nx">cb</span> <span class="k">in</span> <span class="nx">callbacks</span> <span class="k">when</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">__subscriber__</span> <span class="o">!=</span> <span class="nx">caller</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">topics = </span><span class="nx">@topics</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">topic</span><span class="p">)</span>
      <span class="nx">SmartEmitter</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span> <span class="p">{</span> <span class="nx">topics</span> <span class="p">},</span> <span class="nx">args</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Let this Smart Emitter listen on all events on another Emitter. The other
Emitter must have the exact same topics as the Smart Emitter vor this to work.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">onAll: </span><span class="nf">(other) -&gt;</span>
      <span class="nv">ownTopics = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@topics</span><span class="p">)</span>
      <span class="nv">otherTopics = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">other</span><span class="p">.</span><span class="nx">topics</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">compareArrays</span> <span class="nx">ownTopics</span><span class="p">,</span> <span class="nx">otherTopics</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Can&#39;t connect emitters; incompatible topic lists: [#{ownTopics}] and [#{otherTopics}]&quot;</span>
      <span class="nv">self = </span><span class="k">this</span>
      <span class="k">for</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">callbacks</span> <span class="k">of</span> <span class="nx">@topics</span>
        <span class="nx">other</span><span class="p">.</span><span class="kc">on</span> <span class="nx">topic</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">other</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 