<!DOCTYPE html>  <html> <head>   <title>app.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="controls.html">                 controls.coffee               </a>                                           <a class="source" href="emitter.html">                 emitter.coffee               </a>                                           <a class="source" href="hash.html">                 hash.coffee               </a>                                           <a class="source" href="iframe.html">                 iframe.coffee               </a>                                           <a class="source" href="presentation.html">                 presentation.coffee               </a>                                           <a class="source" href="smartEmitter.html">                 smartEmitter.coffee               </a>                                           <a class="source" href="state.html">                 state.coffee               </a>                                           <a class="source" href="sync.html">                 sync.coffee               </a>                                           <a class="source" href="pik7.html">                 pik7.coffee               </a>                                           <a class="source" href="slides.html">                 slides.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Default app view</p>

<ol>
<li>When the app instance is first created, an <code>Iframe</code> instance is created and connected</li>
<li><code>connectIframe()</code> triggers <code>@init()</code> on first load</li>
<li><code>connectIframe()</code> adds an onload event to the iframe, which calls <code>@connectController()</code> and <code>@iframeOnload()</code></li>
<li><code>init()</code> creates a controller from the default state and redirects the iframe to the controller's selected file</li>
<li>as soon as the iframe loads, <code>@connectController()</code> and <code>@iframeOnload()</code> fire</li>
<li><code>@connectController()</code> does many things but mainly connects controller events to actions in the app</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;lib/emitter&#39;</span><span class="p">,</span><span class="s1">&#39;lib/controller&#39;</span><span class="p">,</span> <span class="s1">&#39;lib/iframe&#39;</span><span class="p">,</span> <span class="s1">&#39;lib/hash&#39;</span><span class="p">],</span> <span class="nf">(Emitter, Controller, Iframe, Hash) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>TODO: Nach manuellem browsen folgt Fenster 2 nicht Fenster 1!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="k">class</span> <span class="nx">App</span> <span class="k">extends</span> <span class="nx">Emitter</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Different things need to happen when the iframe loads depending on if this is the
first load or a late change of slides, so <code>@initialized</code> keeps track of this.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">constructor: </span><span class="nf">(defaults) -&gt;</span>
      <span class="k">super</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">)</span>
      <span class="vi">@initialized = </span><span class="kc">no</span>
      <span class="vi">@iframe = </span><span class="k">new</span> <span class="nx">Iframe</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">)</span>
      <span class="nx">@connectIframe</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Connects the iframe to the app. Triggers <code>@init()</code> on first load and sets the
onload handler for the iframe</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">connectIframe: </span><span class="nf">(defaults) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@initialized</span> <span class="k">then</span> <span class="nx">@init</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TODO: This doesn't happen on mobile devices</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@iframe</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nx">@trigger</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">)</span>
        <span class="nx">@connectController</span><span class="p">()</span>
        <span class="nx">@iframeOnload</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Hooked into the iframe's <code>load</code> event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">iframeOnload: </span><span class="o">-&gt;</span>
      <span class="nv">controls = </span><span class="nx">@iframe</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">Pik</span><span class="p">.</span><span class="nx">controls</span>
      <span class="nx">controls</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">goNext</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@controller</span><span class="p">))</span>
      <span class="nx">controls</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;prev&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">goPrev</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@controller</span><span class="p">))</span>
      <span class="nx">controls</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;toggleHidden&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">toggleHidden</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@controller</span><span class="p">))</span>
      <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getSlide</span><span class="p">())</span>
      <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getHidden</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Things to do when the controller reports changes. Also needed for init on first load
of the frame (see <code>@init</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">onFile: </span><span class="nf">(file) -&gt;</span> <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="k">if</span> <span class="nx">file</span> <span class="o">!=</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getFile</span><span class="p">()</span>
    <span class="nv">onSlide: </span><span class="nf">(slide) -&gt;</span> <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">slide</span><span class="p">)</span>
    <span class="nv">onHidden: </span><span class="nf">(state) -&gt;</span> <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>On first load, create a temporary controller from the supplied defaults. The
temporary controller figures out what the <em>real</em> initial state is (apart from the
defaults there are also sync and hash as potential data sources) and triggers the
first real load of the iframe</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">init: </span><span class="nf">(defaults) -&gt;</span>
      <span class="vi">@initialized = </span><span class="kc">yes</span>
      <span class="vi">@controller = </span><span class="k">new</span> <span class="nx">Controller</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
      <span class="nx">@iframe</span><span class="p">.</span><span class="nx">do</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getFile</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Throws away the old controller and creates a new from from a fresh state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">connectController: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Figure out the (short) path to the slides that are loaded into the iframe</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">location = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
      <span class="nv">iframeLocation = </span><span class="nx">@iframe</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
      <span class="nv">basePath = </span><span class="nx">Hash</span><span class="o">::</span><span class="nx">commonPath</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">iframeLocation</span>
      <span class="nv">slidesPath = </span><span class="nx">iframeLocation</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">basePath</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">iframeLocation</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Find out if the current slides are different from the ones that are currently
in the controller state. This happens on manual navigation (e.g. via "browse"
link) and necessitates that the new <code>slide</code> and <code>hidden</code> values <em>must</em> be
default-ish (<code>0</code> and <code>false</code>) - navigating away from the current slides means a
complete reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">newFile = </span><span class="nx">slidesPath</span> <span class="o">!=</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getFile</span><span class="p">()</span>
      <span class="nv">state = </span><span class="p">{</span>
        <span class="nv">file: </span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">slidesPath</span>
        <span class="nv">numSlides: </span><span class="nx">@iframe</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">Pik</span><span class="p">.</span><span class="nx">numSlides</span>
        <span class="nv">slide: </span><span class="k">if</span> <span class="nx">newFile</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getSlide</span><span class="p">()</span>
        <span class="nv">hidden: </span><span class="k">if</span> <span class="nx">newFile</span> <span class="k">then</span> <span class="kc">no</span> <span class="k">else</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">getHidden</span><span class="p">()</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Kill the old controller, create and connect a new one</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@disconnectController</span><span class="p">()</span>
      <span class="vi">@controller = </span><span class="k">new</span> <span class="nx">Controller</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
      <span class="nx">@controller</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">@onFile</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">))</span>
      <span class="nx">@controller</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">@onSlide</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">))</span>
      <span class="nx">@controller</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nx">@onHidden</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Off the current controller (if present)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">disconnectController: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@controller</span><span class="o">?</span>
        <span class="nx">@controller</span><span class="p">.</span><span class="nx">offAll</span><span class="p">()</span>
        <span class="vi">@controller = </span><span class="kc">null</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 